# vim: filetype=bash

#!/bin/bash

# Default values
prefix=/usr/local
debugsym=true
profilesym=false
shared=true
use_npz=true

for arg in "$@"; do
    case "$arg" in
    --prefix=*)
        prefix=`echo ${arg%/} | sed 's/--prefix=//'`
        echo "prefix set to $prefix"
        ;;
    --enable-debug)
        debugsym=true;;
    --disable-debug)
        debugsym=false;;
    --enable-profile)
        profilesym=true;;
    --disable-profile)
        profilesym=false;;
    --enable-shared)
        shared=true;;
    --disable-shared)
        shared=false;;
    --enable-npz)
        use_npz=true;;
    --disable-npz)
        use_npz=false;;

    --help)
        echo 'usage: ./configure [options]'
        echo 'options:'
        echo '  --prefix=<path>:     installation prefix'
        echo '  --enable-debug:      include debug symbols (default on)'
        echo '  --disable-debug:     do not include debug symbols'
        echo '  --enable-profile:    include profile symbols (default off)'
        echo '  --disable-profile:   do not include profile symbols'
        echo '  --enable-shared:     build dynamic linked library. (default on)'
        echo '  --disable-shared:    build static linked library'
        echo '  --enable-npz:        build system with .npz features. (default on)'
        echo '  --disable-npz:       build system without .npz features.'
        echo 'all invalid options are silently ignored'
        exit 0
        ;;
    esac
done

# Check if libzip is installed
# FIXME: There are some issues here: this requires gcc, echo and a unix.like environment. What about icc, clang etc.? :-(
have_libzip=`echo "#include <zip.h>" | gcc -c -o /dev/null -Werror -xc - > /dev/null 2>/dev/null && echo "True" || echo "False"`
echo "zip.h found: $have_libzip"
if [ "$have_libzip" != "True" ]; then
    echo "WARNING: libzip library not found!"
    echo "libzip is highly recommended and was not found on this system. Please install the libzip packet(s) for your system." 
    use_npz=false
fi 

echo 'generating Makefile ...'
echo "PREFIX  = $prefix" >Makefile
if $debugsym; then
    echo 'dbg     = -g' >>Makefile
fi
if $profilesym; then
    echo 'profile = -pg' >>Makefile
fi
echo "shared  = $shared" >> Makefile
echo "use_npz = $use_npz" >> Makefile
echo "include Makefile.in" >>Makefile
echo "configuration complete, type 'make' to build."
